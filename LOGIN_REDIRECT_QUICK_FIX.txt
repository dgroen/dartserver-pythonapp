╔════════════════════════════════════════════════════════════════════════════╗
║                    LOCALHOST LOGIN REDIRECT FIX                             ║
║                   (Redirect goes to letsplaydarts.eu)                       ║
╚════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────────┐
│ PROBLEM                                                                      │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ When clicking "Login with WSO2" on http://localhost:5000, the app           │
│ redirects to https://letsplaydarts.eu/callback instead of                   │
│ http://localhost:5000/callback                                              │
│                                                                              │
│ ❌ Current behavior: localhost:5000 → letsplaydarts.eu ✗                   │
│ ✅ Expected behavior: localhost:5000 → localhost:5000 ✓                    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ ROOT CAUSE                                                                   │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ WSO2 OAuth2 client is registered ONLY with:                                 │
│   ✓ https://letsplaydarts.eu/callback                                       │
│   ✗ http://localhost:5000/callback (NOT registered)                        │
│                                                                              │
│ WSO2 Security Rule:                                                          │
│   "You can only redirect to URLs that are explicitly registered"            │
│                                                                              │
│ What happens:                                                                │
│   1. App requests redirect to localhost → WSO2 check fails                  │
│   2. WSO2 falls back to default: letsplaydarts.eu                           │
│   3. Browser gets redirected to wrong domain                                │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ SOLUTION (Pick ONE)                                                          │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ 🚀 OPTION 1: Automatic Fix (RECOMMENDED)                                    │
│    ────────────────────────────────────                                     │
│                                                                              │
│    cd /data/dartserver-pythonapp                                            │
│    python3 helpers/fix-wso2-localhost-callback.py                           │
│                                                                              │
│    ✓ Connects to WSO2 automatically                                         │
│    ✓ Finds your app                                                         │
│    ✓ Adds localhost callback URL                                            │
│    ✓ Verifies success                                                       │
│                                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ 🔧 OPTION 2: Manual Fix via WSO2 Web UI                                     │
│    ──────────────────────────────────                                       │
│                                                                              │
│    1. Open browser: https://localhost:9443/carbon                           │
│    2. Login: admin / admin                                                   │
│    3. Go: Main → Identity → Service Providers                               │
│    4. Find and click "Edit" on your application                             │
│    5. Find: OAuth/OpenID Connect Configuration                              │
│    6. Update: Callback URL field                                            │
│       Add: http://localhost:5000/callback                                   │
│    7. Click: Update or Save                                                 │
│    8. Clear browser cookies and try login again                             │
│                                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ 📖 OPTION 3: See Detailed Guides                                            │
│    ──────────────────────────────                                           │
│                                                                              │
│    • FIX_LOCALHOST_LOGIN_REDIRECT.md - Complete guide with troubleshooting  │
│    • WSO2_LOCALHOST_CALLBACK_FIX.md - WSO2-specific instructions            │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ AFTER THE FIX                                                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ 1. Clear browser cache & cookies (Ctrl+Shift+Delete)                        │
│                                                                              │
│ 2. Test login:                                                               │
│    • Visit: http://localhost:5000                                           │
│    • Click: "🔐 Login with WSO2"                                            │
│    • Should redirect to: https://localhost:9443 (WSO2 login page)           │
│    • Enter credentials                                                       │
│    • Should redirect back to: http://localhost:5000 ✅                      │
│                                                                              │
│ 3. If still having issues:                                                   │
│    • Check: Are browser cookies enabled?                                    │
│    • Check: Is WSO2 running? (docker-compose -f docker-compose-wso2.yml ps) │
│    • Check: Server logs (docker-compose logs app)                           │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│ WHAT'S WORKING CORRECTLY                                                     │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ ✅ Flask app configuration (.env)                                           │
│    • APP_DOMAIN=localhost:5000                                              │
│    • APP_SCHEME=http                                                         │
│    • SESSION_COOKIE_SECURE=False                                            │
│                                                                              │
│ ✅ Dynamic redirect URI generation                                          │
│    • Config.CALLBACK_URL = http://localhost:5000/callback                   │
│                                                                              │
│ ✅ Login page frontend                                                       │
│    • Uses dynamic {{ auth_url }} (not hardcoded)                            │
│                                                                              │
│ ✅ Authorization URL function                                               │
│    • Correctly generates OAuth2 parameters                                   │
│    • Passes correct localhost callback to WSO2                              │
│                                                                              │
│ ❌ ONLY THING MISSING                                                        │
│    • WSO2 OAuth2 client needs http://localhost:5000/callback registered     │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘

📚 Related Files:
   ├─ FIX_LOCALHOST_LOGIN_REDIRECT.md (Comprehensive guide)
   ├─ LOCALHOST_LOGIN_REDIRECT_ISSUE_SUMMARY.md (Technical analysis)
   ├─ WSO2_LOCALHOST_CALLBACK_FIX.md (WSO2 troubleshooting)
   ├─ LOCALHOST_QUICKSTART.md (Getting started)
   └─ helpers/fix-wso2-localhost-callback.py (Automated fix)

🎯 Next Steps:
   1. Run: python3 helpers/fix-wso2-localhost-callback.py
   2. Clear browser cookies
   3. Test login at http://localhost:5000
   4. Success! ✅